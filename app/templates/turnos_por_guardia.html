{# /web/app/templates/turnos_por_guardia.html #}
{% extends "base.html" %}

{% block title %}Consulta por trabajador · Turnos Guardias · Grupo CS{% endblock %}

{% block content %}
<div class="container-fluid py-3">
  <div class="d-flex align-items-start justify-content-between gap-3 flex-wrap mb-3">
    <div class="section-header mb-0">
      <h1 class="section-title">Consulta de turnos por trabajador</h1>
      <div class="section-subtitle">Filtra por instalación, trabajador y rango de fechas para análisis y auditoría.</div>
      <div class="section-divider"></div>
    </div>

    <div class="d-flex gap-2">
      <a class="btn btn-secondary" href="/turnos">Volver a listado por día</a>
    </div>
  </div>

  <div class="card mb-3">
    <div class="card-body">
      <form method="get" class="row g-3" id="formConsulta">
        <div class="col-12 col-lg-4">
          <label class="form-label">Obra / Instalación</label>
          <select class="form-select" name="instalacion_id" id="instalacionSelect" required>
            <option value="">-- Seleccionar instalación --</option>
            {% for inst in instalaciones %}
              <option value="{{ inst.id }}" {% if instalacion_id == inst.id %}selected{% endif %}>
                {{ inst.nombre }}
              </option>
            {% endfor %}
          </select>
        </div>

        <div class="col-12 col-lg-5">
          <label class="form-label">Trabajador (con turnos en la instalación)</label>
          <select class="form-select"
                  name="guardia_rut"
                  id="guardiaSelect"
                  {% if not instalacion_id %}disabled{% endif %}
                  required>
            <option value="">-- Seleccionar trabajador --</option>
          </select>
          <div class="form-text">Se muestran solo guardias activos con turnos registrados en esa instalación.</div>
        </div>

        <div class="col-12 col-lg-3">
          <label class="form-label d-none d-lg-block">&nbsp;</label>
          <div class="d-flex gap-2 align-items-stretch">
            <button class="btn btn-primary flex-grow-1" id="btnConsultar" type="submit" disabled>Consultar</button>
            <a class="btn btn-outline-secondary" href="/turnos/por-guardia" title="Reiniciar filtros de la consulta">
              Limpiar
            </a>
          </div>
        </div>

        <div class="col-12 col-lg-3">
          <label class="form-label">Desde</label>
          <input class="form-control" type="date" name="desde" id="desdeInput"
                 value="{{ resumen.desde.strftime('%Y-%m-%d') if resumen.desde else sugerido_desde.strftime('%Y-%m-%d') }}">
        </div>

        <div class="col-12 col-lg-3">
          <label class="form-label">Hasta</label>
          <input class="form-control" type="date" name="hasta" id="hastaInput"
                 value="{{ resumen.hasta.strftime('%Y-%m-%d') if resumen.hasta else sugerido_hasta.strftime('%Y-%m-%d') }}">
        </div>

        <div class="col-12 col-lg-6 d-flex align-items-end">
          <div class="small text-muted">
            Consejo operativo: selecciona instalación y trabajador; el sistema puede auto-seleccionar el primer trabajador disponible.
          </div>
        </div>
      </form>
    </div>
  </div>

  {% if guardia and turnos %}
  <div class="card mb-3">
    <div class="card-body">
      <div class="d-flex justify-content-between flex-wrap gap-2">
        <div>
          <h6 class="mb-1">{{ resumen.nombre }}</h6>
          <div class="text-muted small">Instalación: <b>{{ resumen.instalacion_nombre }}</b></div>
          <div class="text-muted small">RUT: <b>{{ resumen.rut }}</b> · Modalidad: <b>{{ resumen.modalidad }}</b></div>
          <div class="text-muted small">
            Turnos: <b>{{ resumen.cantidad_turnos }}</b> (Día: {{ resumen.turnos_dia }}, Noche: {{ resumen.turnos_noche }}) ·
            Valorizados: <b>{{ resumen.cantidad_valorizados }}</b>
          </div>
        </div>

        <div class="text-end">
          <div class="text-muted small">Total valorizado</div>
          <div class="fs-5"><b>${{ "{:,}".format(resumen.monto_total).replace(",", ".") }}</b></div>
          <div class="text-muted small">
            Base: ${{ "{:,}".format(resumen.monto_base).replace(",", ".") }} ·
            Recargo: ${{ "{:,}".format(resumen.monto_recargo).replace(",", ".") }}
          </div>
          <div class="text-muted small">
            {% set mins = (resumen.minutos_feriado or 0) %}
            {% set h = (mins // 60) %}
            {% set m = (mins % 60) %}
            Hrs. feriado total:
            <b>
              {% if mins == 0 %}0 h
              {% elif m == 0 %}{{ h }} h
              {% else %}{{ h }} h {{ m }} m
              {% endif %}
            </b>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card-body">
      <h6 class="mb-3">Detalle de turnos</h6>

      <div class="table-responsive table-wrap">
        <table class="table table-striped table-hover align-middle mb-0">
          <thead>
            <tr>
              <th>ID</th>
              <th>Turno</th>
              <th>Inicio</th>
              <th>Fin</th>
              <th>Hrs. feriado</th>
              <th>Recargo</th>
              <th>Monto</th>
              <th class="text-end"></th>
            </tr>
          </thead>
          <tbody>
            {% for t in turnos %}
            <tr>
              <td>{{ t.id }}</td>
              <td>
                {% if t.turno_codigo == "DIA" %}
                  <span class="badge badge-soft">DÍA</span>
                {% else %}
                  <span class="badge badge-soft">NOCHE</span>
                {% endif %}
                {% if t.es_adicional %}
                  <span class="badge badge-success ms-1">Adicional</span>
                {% endif %}
              </td>

              <td>{{ t.inicio_dt.strftime("%d-%m-%Y %H:%M") }}</td>
              <td>{{ t.fin_dt.strftime("%d-%m-%Y %H:%M") }}</td>

              <td>
                {% set mins = (t.minutos_feriado or 0) %}
                {% set h = (mins // 60) %}
                {% set m = (mins % 60) %}
                {% if mins == 0 %}0 h
                {% elif m == 0 %}{{ h }} h
                {% else %}{{ h }} h {{ m }} m
                {% endif %}
              </td>

              <td>
                {% if t.minutos_feriado and t.minutos_feriado > 0 %}
                  <span class="badge badge-soft"
                        {% if t.feriado_detalle_calculo %}title="{{ t.feriado_detalle_calculo }}"{% endif %}>
                    {{ t.feriado_tipo_aplicado }} {{ t.feriado_porcentaje_aplicado }}%
                  </span>
                {% else %}
                  -
                {% endif %}
              </td>

              <td>
                ${{ "{:,}".format(t.monto_total or 0).replace(",", ".") }}
                {% if t.monto_recargo and t.monto_recargo > 0 %}
                  <div class="text-muted small">Recargo: ${{ "{:,}".format(t.monto_recargo).replace(",", ".") }}</div>
                {% endif %}
              </td>

              <td class="text-end">
                <a class="btn btn-sm btn-outline-primary" href="/turnos/{{ t.id }}/editar">Editar</a>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  {% elif instalacion_id and guardia_rut and not turnos %}
    <div class="alert alert-info">No hay turnos en el rango consultado.</div>
  {% else %}
    <div class="alert alert-secondary">Selecciona una instalación, un trabajador y un rango de fechas para consultar.</div>
  {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
function setConsultarState() {
  const instalacionSelect = document.getElementById("instalacionSelect");
  const guardiaSelect = document.getElementById("guardiaSelect");
  const btn = document.getElementById("btnConsultar");

  const ok = Boolean(instalacionSelect.value) && Boolean(guardiaSelect.value) && !guardiaSelect.disabled;
  btn.disabled = !ok;
}

async function cargarGuardias(instId, rutSeleccionado) {
  const guardiaSelect = document.getElementById("guardiaSelect");
  guardiaSelect.innerHTML = '<option value="">-- Seleccionar trabajador --</option>';

  if (!instId) {
    guardiaSelect.disabled = true;
    setConsultarState();
    return;
  }

  guardiaSelect.disabled = true;
  setConsultarState();

  const res = await fetch(`/api/guardias-por-instalacion?inst_id=${encodeURIComponent(instId)}`);
  const data = await res.json();

  for (const g of data) {
    const opt = document.createElement("option");
    opt.value = g.rut;
    opt.textContent = g.label;
    if (rutSeleccionado && rutSeleccionado === g.rut) opt.selected = true;
    guardiaSelect.appendChild(opt);
  }

  if (!guardiaSelect.value) {
    const firstReal = guardiaSelect.querySelector('option[value]:not([value=""])');
    if (firstReal) guardiaSelect.value = firstReal.value;
  }

  guardiaSelect.disabled = false;
  setConsultarState();
}

document.addEventListener("DOMContentLoaded", () => {
  const instalacionSelect = document.getElementById("instalacionSelect");
  const guardiaSelect = document.getElementById("guardiaSelect");

  const instId = instalacionSelect.value;
  const rutSeleccionado = "{{ guardia_rut or '' }}";

  cargarGuardias(instId, rutSeleccionado);

  instalacionSelect.addEventListener("change", () => {
    cargarGuardias(instalacionSelect.value, "");
  });

  guardiaSelect.addEventListener("change", () => setConsultarState());

  setConsultarState();
});
</script>
{% endblock %}
