{# app/templates/base.html #}
<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>
    Turnos Guardias · Grupo CS
    {% if self.title() %} · {% block title %}{% endblock %}{% endif %}
  </title>

  <!-- favicon -->
  <link rel="icon" type="image/png" sizes="32x32"
        href="{{ url_for('static', filename='img/genfavicon-256.png') }}?v=20260117-1">
  <link rel="icon" type="image/x-icon"
        href="{{ url_for('static', filename='img/favicon.ico') }}?v=20260117-1">

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Custom CSS (cache-buster) -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}?v=20260117-3">

  <!-- Bootstrap Icons (si las sigues usando en otras vistas) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

  {% block head %}{% endblock %}
</head>

<body>
  {# Detecta si estamos en login (pantalla pública) #}
  {% set endpoint = request.endpoint or "" %}
  {% set is_login = (endpoint in ["main.login", "main.login_post"]) %}

  <header class="topbar">
    <div class="topbar-inner container-fluid">

      <!-- LEFT: Marca -->
      <div class="topbar-left">
        <img
          src="{{ url_for('static', filename='img/logo-grupo-cs.png') }}"
          alt="Grupo CS"
          class="topbar-logo"
        >
        <div class="topbar-text">
          <div class="system-name">Turnos Guardias</div>
          <div class="system-tagline">Control operativo de turnos y trazabilidad</div>
        </div>
      </div>

      {% if not is_login %}
        <!-- RIGHT: Navegación + sesión -->
        <div class="topbar-right">

          <nav class="nav-links">
            <a href="{{ url_for('main.index') }}"
               class="{% if request.path == url_for('main.index') %}active{% endif %}">
              Inicio
            </a>

            <a href="/guardias"
               class="{% if request.path.startswith('/guardias') %}active{% endif %}">
              Guardias
            </a>

            <a href="{{ url_for('main.instalaciones_listado') }}"
               class="{% if request.path.startswith('/instalaciones') %}active{% endif %}">
              Obras
            </a>

            <a href="{{ url_for('main.turnos_listado') }}"
               class="{% if request.path.startswith('/turnos') %}active{% endif %}">
              Turnos
            </a>

            <a href="{{ url_for('main.turnos_por_guardia') }}"
               class="{% if request.path.startswith(url_for('main.turnos_por_guardia')) %}active{% endif %}">
              Consulta por trabajador
            </a>

            {% if current_user.is_authenticated and (current_user.rol or "")|upper in ["ADMIN","OPERADOR","REVISOR"] %}
              <a href="{{ url_for('main.reporte_resumen_turnos') }}"
                 class="{% if request.path.startswith(url_for('main.reporte_resumen_turnos')) %}active{% endif %}">
                Reportes
              </a>
            {% endif %}

            {% if current_user.is_authenticated and current_user.es_admin() %}
              <span class="nav-sep">|</span>
              <a href="{{ url_for('usuarios.usuarios_listado') }}"
                 class="{% if request.path.startswith(url_for('usuarios.usuarios_listado')) %}active{% endif %}">
                Usuarios
              </a>
            {% endif %}
          </nav>

          <div class="user-session">
            {% if current_user.is_authenticated %}
              <span class="user-label">Conectado como</span>
              <span class="user-name">{{ current_user.username }}</span>
              <a href="{{ url_for('main.logout') }}" class="btn-logout">Salir</a>
            {% else %}
              <a href="{{ url_for('main.login') }}" class="btn-logout">Ingresar</a>
            {% endif %}
          </div>

        </div>
      {% endif %}

    </div>
  </header>

  <main class="content">
    <!-- Flash messages dentro del flujo principal -->
    <div class="container-fluid mt-3">
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          <div class="flash-container">
            {% for cat, m in messages %}
              {% set bs = "warning" %}
              {% if cat in ["success"] %}{% set bs = "success" %}
              {% elif cat in ["error", "danger"] %}{% set bs = "danger" %}
              {% elif cat in ["info"] %}{% set bs = "info" %}
              {% endif %}

              <div class="alert alert-{{ bs }} alert-dismissible fade show mb-2" role="alert">
                {{ m }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Cerrar"></button>
              </div>
            {% endfor %}
          </div>
        {% endif %}
      {% endwith %}
    </div>

    {% block content %}{% endblock %}
  </main>

  <footer class="footer">
    <div class="container-fluid footer-inner">
      <span>© {{ 2026 }} Grupo CS · Turnos Guardias</span>
      <span class="footer-right">Desarrollado por AOE Asesorías</span>
    </div>
  </footer>

  <!-- Bootstrap JS Bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  {% block scripts %}{% endblock %}
</body>
</html>
