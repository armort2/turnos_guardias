{# app/templates/instalaciones_listado.html #}
{% extends "base.html" %}

{% block title %}Obras · Turnos Guardias · Grupo CS{% endblock %}

{% block content %}
<div class="container-fluid py-3">

  <div class="d-flex align-items-start justify-content-between gap-3 flex-wrap mb-3">
    <div class="section-header mb-0">
      <h1 class="section-title">Obras / Instalaciones</h1>
      <div class="section-subtitle">Administración y visibilidad según permisos.</div>
      <div class="section-divider"></div>
    </div>

    <div class="d-flex gap-2">
      {% if current_user.is_authenticated and current_user.es_admin() %}
        <a class="btn btn-primary" href="{{ url_for('main.instalacion_nueva') }}">
          <i class="bi bi-plus-circle me-1"></i> Nueva obra
        </a>
      {% endif %}
    </div>
  </div>

  <div class="card mb-3">
    <div class="card-body">
      <form method="get" action="{{ url_for('main.instalaciones_listado') }}" class="row g-3 align-items-end">
        <div class="col-12 col-md-8">
          <label class="form-label">Buscar</label>
          <input type="text" name="q" class="form-control" value="{{ q }}" placeholder="Nombre de obra/instalación">
        </div>

        <div class="col-12 col-md-4">
          <div class="d-flex gap-2">
            <button class="btn btn-primary w-50" type="submit">
              <i class="bi bi-search me-1"></i> Filtrar
            </button>
            <a class="btn btn-outline-secondary w-50" href="{{ url_for('main.instalaciones_listado') }}">
              Limpiar
            </a>
          </div>
        </div>
      </form>
    </div>
  </div>

  <div class="card">
    <div class="card-body">
      <div class="table-responsive table-wrap">
        <table class="table table-striped table-hover align-middle mb-0">
          <thead>
            <tr>
              <th style="width: 90px;">ID</th>
              <th>Nombre</th>
              <th style="width: 170px;" class="text-end">Turnos (no anul.)</th>
              <th style="width: 220px;" class="text-end">Acciones</th>
            </tr>
          </thead>
          <tbody>
            {% for inst in instalaciones %}
              <tr>
                <td class="text-muted">{{ inst.id }}</td>
                <td>{{ inst.nombre }}</td>
                <td class="text-end">{{ (turnos_map.get(inst.id, 0) or 0) }}</td>
                <td class="text-end">
                  {% if current_user.is_authenticated and current_user.es_admin() %}
                    <div class="d-inline-flex gap-2">
                      <a class="btn btn-sm btn-outline-primary"
                         href="{{ url_for('main.instalacion_editar', instalacion_id=inst.id) }}">
                        <i class="bi bi-pencil-square me-1"></i> Editar
                      </a>

                      <form method="post"
                            action="{{ url_for('main.instalacion_eliminar', instalacion_id=inst.id) }}"
                            class="m-0"
                            onsubmit="return confirm('¿Eliminar la obra/instalación? Esta acción no se puede deshacer.');">
                        <button class="btn btn-sm btn-outline-danger" type="submit">
                          <i class="bi bi-trash me-1"></i> Eliminar
                        </button>
                      </form>
                    </div>
                  {% else %}
                    <span class="text-muted">Sin acciones</span>
                  {% endif %}
                </td>
              </tr>
            {% else %}
              <tr>
                <td colspan="4" class="text-center text-muted py-4">
                  No hay instalaciones para mostrar.
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

</div>
{% endblock %}
